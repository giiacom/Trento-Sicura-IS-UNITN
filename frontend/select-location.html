<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Select Location</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <link href="../src/output.css" rel="stylesheet">
</head>
<body class="bg-gray-200 flex items-center justify-center h-screen">

    <div class="bg-white p-4 rounded-lg shadow-lg w-full max-w-2xl h-[80vh] flex flex-col">
        <h2 class="text-lg font-semibold mb-2">Select a Location</h2>

        <!-- Map Container -->
        <div id="map" class="w-full" style="height: 80vh;"></div>
        <div class="flex justify-end space-x-4 mt-4">
            <button onclick="cancelSelection()" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600">
                Cancel
            </button>
            <button onclick="confirmLocation()" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">
                Confirm
            </button>
        </div>
    </div>
    
    <script>
        let selectedLatLng = null;
        let map, marker;

        window.onload = function () {
            console.log("Initializing map...");

            // Check if Leaflet is loaded
            if (typeof L === 'undefined') {
                console.error("Leaflet library failed to load!");
                return;
            } else {
                console.log("Leaflet loaded successfully.");
            }

            try {
                // Initialize the map
                if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                var userLat = position.coords.latitude;
                var userLon = position.coords.longitude;
    
                // Center the map on the user's position
                map.setView([userLat, userLon], 13);
            }, function () {
                alert("Impossibile ottenere la posizione.");
                map.setView([46.066666, 11.116667], 13); // Default to Trento if geolocation fails
            });
        } else {
            alert("Geolocalizzazione non supportata dal browser.");
            map.setView([46.066666, 11.116667], 13);
        }
        
                map = L.map('map')

                // Tile Layer from OpenStreetMap
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap contributors'
                }).addTo(map);

                // Handle click on the map
                map.on('click', function (e) {
                    selectedLatLng = e.latlng;

                    // Place or update the marker
                    if (marker) {
                        marker.setLatLng(selectedLatLng);
                    } else {
                        marker = L.marker(selectedLatLng).addTo(map);
                    }
                });
            } catch (error) {
                console.error("Error initializing the map:", error);
            }
        };

        function cancelSelection() {
            window.location.href = 'report.html'; // Go back to the report form without saving
        }

        function confirmLocation() {
            if (selectedLatLng) {
                const locationString = `{"lat": ${selectedLatLng.lat.toFixed(6)}, "lng": ${selectedLatLng.lng.toFixed(6)}}`;
                localStorage.setItem('selectedLocation', locationString); // Store location in localStorage
            }
            window.location.href = 'report.html'; // Go back to the report form
        }
    </script>

</body>
</html>